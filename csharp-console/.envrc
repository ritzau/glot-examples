# Nix Polyglot Environment Setup

# Install or update glot CLI if needed
if [[ ! -f .cache/bin/glot ]] || [[ flake.lock -nt .cache/bin/glot ]]; then
    echo "ðŸ”„ Updating glot CLI..."
    mkdir -p .cache/bin
    nix build .#glot-cli -o result-glot-cli
    chmod +w .cache/bin/glot 2>/dev/null || true  # Make writable if exists
    cp result-glot-cli/bin/glot .cache/bin/glot
    rm result-glot-cli
    echo "âœ… Glot CLI updated"
fi

# Add glot to PATH (fast)
PATH_add .cache/bin

# Install git hooks directly (fast, simple)
if [[ ! -f .git/hooks/pre-commit ]] || [[ ! -f .git/hooks/pre-push ]]; then
    echo "ðŸŽ£ Installing git hooks..."
    mkdir -p .git/hooks
    
    # Pre-commit: format only (fast)
    cat > .git/hooks/pre-commit << 'EOF'
#!/usr/bin/env bash
echo "ðŸŽ¨ Running pre-commit formatting..."
nix fmt
EOF
    chmod +x .git/hooks/pre-commit
    
    # Pre-push: comprehensive check (can be bypassed)
    cat > .git/hooks/pre-push << 'EOF'
#!/usr/bin/env bash
echo "ðŸš€ Running pre-push checks..."
glot check
EOF
    chmod +x .git/hooks/pre-push
    
    echo "âœ… Git hooks installed successfully!"
fi